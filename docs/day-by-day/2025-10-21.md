# üìÖ Day 2 - Complete Data Platform Infrastructure

**Data:** 21-22 de Outubro de 2025
**Foco:** Configura√ß√£o completa do Data Platform (Storage, Search, Orchestration, ML Tracking)

---

## üéØ Objetivos Alcan√ßados

### Data Layer ‚úÖ
‚úÖ **MinIO S3-compatible storage** configurado com buckets Medallion (lh-bronze, lh-silver, lh-gold)
‚úÖ **PostgreSQL 15** com 3 databases (govcontracts, mlflow, airflow)
‚úÖ **Redis 7** para cache e message broker (Celery)
‚úÖ **OpenSearch 3** para search engine e NLP analysis
‚úÖ **OpenSearch Dashboards** para visualiza√ß√£o

### ML & Tracking Layer ‚úÖ
‚úÖ **MLflow** integrado com MinIO (artefatos) e PostgreSQL (metadados)

### Orchestration Layer ‚úÖ
‚úÖ **Apache Airflow 3.1.0** com CeleryExecutor (4 containers)
  - Webserver, Scheduler, Worker, Triggerer
  - Integrado com PostgreSQL, Redis, MinIO

### Infrastructure ‚úÖ
‚úÖ **Docker Compose** completo com 11 containers
‚úÖ **Rede customizada** (172.30.0.0/16) com IPs est√°ticos
‚úÖ **Documenta√ß√£o completa** (INFRASTRUCTURE.md, minio.md, day-by-day)

---

## üîß Decis√µes T√©cnicas Importantes

### 1. Portas Customizadas

Para evitar conflitos com outros projetos em desenvolvimento:

- **MinIO S3 API:** `9100` (host) ‚Üí `9000` (container)
- **MinIO Console:** `9101` (host) ‚Üí `9001` (container)
- **PostgreSQL:** `5433` (host) ‚Üí `5432` (container)
- **Redis:** `6381` (host) ‚Üí `6379` (container)
- **MLflow:** `5000` (host) ‚Üí `5000` (container)
- **OpenSearch API:** `9201` (host) ‚Üí `9200` (container)
- **OpenSearch Dashboards:** `5602` (host) ‚Üí `5601` (container)
- **Airflow Webserver:** `8081` (host) ‚Üí `8080` (container)

### 2. Rede Docker

- **Subnet:** `172.30.0.0/16`
- **Network name:** `govcontracts-network`
- **Motivo:** Subnets 172.20.x e 172.25.x j√° estavam em uso

**IPs est√°ticos:**
- PostgreSQL: `172.30.0.5`
- Redis: `172.30.0.6`
- MLflow: `172.30.0.7`
- MinIO: `172.30.0.10`
- OpenSearch: `172.30.0.11`
- OpenSearch Dashboards: `172.30.0.12`
- Airflow Webserver: `172.30.0.20`
- Airflow Scheduler: `172.30.0.21`
- Airflow Worker: `172.30.0.22`
- Airflow Triggerer: `172.30.0.23`

### 3. Armazenamento

- **Volumes nomeados** do Docker (n√£o bind mounts)
- Gerenciamento autom√°tico pelo Docker
- Facilita backup e migra√ß√£o

### 4. MinIO Buckets (Medallion Architecture)

Cria√ß√£o autom√°tica via container `minio-init`:

- **lh-bronze/** - Dados brutos (RAW) - prefixo `lh-` indica Lakehouse/Medallion
- **lh-silver/** - Dados limpos e validados
- **lh-gold/** - Features ML-ready
- **mlflow/** - Artefatos e modelos ML (sem prefixo - n√£o √© Medallion)
- **backups/** - Backups do sistema
- **tmp/** - Arquivos tempor√°rios (auto-delete 7 dias)

**Versioning habilitado:** lh-bronze, lh-silver, lh-gold, mlflow

### 5. MLflow com MinIO

MLflow configurado para armazenar artefatos no MinIO:
- Backend: PostgreSQL (metadados)
- Artifact Store: MinIO S3 (modelos, plots, etc)
- Endpoint interno: `http://minio:9000`

---

## üêõ Problemas Resolvidos

### Problema 1: pg_vector compilation failure
**Erro:** `clang-19: No such file or directory`

**Tentativas:**
1. ‚ùå Instalar clang15 e llvm15-dev
2. ‚ùå Criar symlink clang-15 ‚Üí clang-19
3. ‚ùå Atualizar pgvector para 0.8.1
4. ‚ùå Usar OPTFLAGS="" para pular bitcode

**Solu√ß√£o:** ‚úÖ Usar imagem oficial `pgvector/pgvector:0.8.1-pg16`

### Problema 2: Docker Compose version warning
**Aviso:** `'version' is obsolete`

**Solu√ß√£o:** Remover campo `version:` do docker-compose.yml (obsoleto no Compose v2)

### Problema 3: Network subnet conflicts
**Erro:** `Pool overlaps with other one on this address space`

**Conflitos encontrados:**
- 172.20.0.0/16 ‚Üí `enfconcursoscom_enfconcursos_network`
- 172.25.0.0/16 ‚Üí `faace-site-principal_faace-network`

**Solu√ß√£o:** Usar subnet `172.30.0.0/16` (dispon√≠vel)

### Problema 4: Port conflicts
**Erro:** `address already in use`

**Portas em conflito:** 9000, 9001, 5432, 6379

**Solu√ß√£o:** Usar portas n√£o-padr√£o (9100, 9101, 5433, 6381)

### Problema 5: PostgreSQL permission denied
**Erro:** `mkdir: cannot create directory '/var/lib/postgresql/data': Permission denied`

**Solu√ß√£o:**
```bash
docker compose down -v  # Remove volumes corrompidos
docker compose up -d    # Recria com permiss√µes corretas
```

### Problema 6: Redis configuration syntax error
**Erro:** `Invalid save parameters` at line 21

**Causa:** Redis 7.4.5 n√£o aceita coment√°rios inline em diretivas `save`

**Errado:**
```conf
save 900 1      # Save after 900 seconds
```

**Correto:**
```conf
# Save after 900 seconds if at least 1 key changed
save 900 1
```

### Problema 7: PostgreSQL locale error
**Erro:** `invalid value for parameter "lc_monetary": "pt_BR.utf8"`

**Causa:** Imagem pgvector (Debian-based) n√£o tem locale pt_BR instalado

**Solu√ß√£o:** Trocar todos os locales de `pt_BR.utf8` para `en_US.utf8`

### Problema 8: MinIO port mapping wrong
**Observa√ß√£o:** Logs do MinIO mostrando portas 9000/9001 mas mapeamento estava incorreto

**Problema:** docker-compose.yml tinha `9100:9100` e `9101:9101`

**Solu√ß√£o:** Corrigir para `9100:9000` e `9101:9001`

---

## üìÅ Arquivos Criados/Modificados

### Docker Infrastructure

**Criados:**
- `infrastructure/docker/minio/Dockerfile`
- `infrastructure/docker/minio/init-buckets.sh`
- `infrastructure/docker/postgres/Dockerfile`
- `infrastructure/docker/postgres/postgresql.conf`
- `infrastructure/docker/postgres/pg_hba.conf`
- `infrastructure/docker/postgres/init-scripts/01-create-extensions.sql`
- `infrastructure/docker/postgres/init-scripts/02-create-schemas.sql`
- `infrastructure/docker/redis/Dockerfile`
- `infrastructure/docker/redis/redis.conf`
- `infrastructure/docker/README.md` (518 linhas)

**Modificados:**
- `docker-compose.yml` (root) - Atualizado com minio-init, IPs est√°ticos, subnet customizada
- `Dockerfile.mlflow` - Integra√ß√£o com MinIO

### Documenta√ß√£o

**Atualizados:**
- `docs/lake-house/minio.md` (1100+ linhas)
  - Adicionada se√ß√£o "Decis√µes de Implementa√ß√£o"
  - Todas as portas atualizadas para 9100/9101
  - Adicionados troubleshooting de conflitos de rede e portas
  - Exemplos Python atualizados
  - Checklist final expandido

**Criados:**
- `docs/day-by-day/2025-10-21.md` (este arquivo)

---

## ‚úÖ Valida√ß√£o Final

```bash
# 1. Todos os containers rodando
docker compose ps
# STATUS: ‚úÖ Todos healthy

# 2. MinIO API acess√≠vel
curl http://localhost:9100/minio/health/live
# RESULTADO: ‚úÖ 200 OK

# 3. MinIO Console acess√≠vel
curl -I http://localhost:9101
# RESULTADO: ‚úÖ 200 OK

# 4. Buckets criados
docker compose logs minio-init
# RESULTADO: ‚úÖ 6 buckets criados com versioning

# 5. Rede configurada
docker network inspect govcontracts-network
# RESULTADO: ‚úÖ Subnet 172.30.0.0/16, 4 containers conectados
```

---

## üîó URLs de Acesso

### Data Layer
- **MinIO Console:** http://localhost:9101 (minioadmin/minioadmin)
- **MinIO S3 API:** http://localhost:9100
- **PostgreSQL:** localhost:5433 (admin/dev123)
- **Redis:** localhost:6381
- **OpenSearch API:** http://localhost:9201
- **OpenSearch Dashboards:** http://localhost:5602

### ML & Orchestration
- **MLflow:** http://localhost:5000
- **Airflow:** http://localhost:8081 (airflow/airflow)

---

## üéì Aprendizados

1. **Docker Compose v2** n√£o usa mais campo `version:` - √© autom√°tico
2. **Healthchecks** usam porta INTERNA do container, n√£o externa
3. **Port mapping** formato √© sempre `HOST:CONTAINER`
4. **pgvector oficial** √© melhor que compilar do zero
5. **Redis 7.4+** n√£o aceita coment√°rios inline em `save` directives
6. **Subnets Docker** devem ser verificadas antes de usar (evitar overlaps)
7. **Init containers** s√£o √∫teis para setup autom√°tico (ex: minio-init, airflow-init)
8. **IPs est√°ticos** facilitam comunica√ß√£o entre containers
9. **Airflow CeleryExecutor** requer PostgreSQL + Redis (n√£o funciona com SQLite)
10. **OpenSearch** √© mais leve que Elasticsearch para desenvolvimento (sem security overhead)
11. **Bucket naming** com prefixos (`lh-`) deixa clara a arquitetura Medallion

---

## üÜï Adi√ß√µes Finais (Dia 2 - Parte 2)

### OpenSearch 3 + Dashboards

**Containers adicionados:**
- `govcontracts-opensearch` (172.30.0.11) - porta 9201
- `govcontracts-opensearch-dashboards` (172.30.0.12) - porta 5602

**Configura√ß√£o:**
- Single-node cluster (desenvolvimento)
- Security disabled (sem autentica√ß√£o)
- JVM: 512MB heap
- Volume: `opensearch_data`

**Uso no projeto:**
- Full-text search em editais (fuzzy matching, tokeniza√ß√£o PT-BR)
- Busca sem√¢ntica com vector search (embeddings BERT)
- An√°lise NLP: detec√ß√£o de cl√°usulas restritivas
- Aggregations para dashboards anal√≠ticos

### Apache Airflow 3.1.0

**Containers adicionados:**
- `govcontracts-airflow-webserver` (172.30.0.20) - porta 8081
- `govcontracts-airflow-scheduler` (172.30.0.21)
- `govcontracts-airflow-worker` (172.30.0.22)
- `govcontracts-airflow-triggerer` (172.30.0.23)
- `govcontracts-airflow-init` (one-shot)

**Arquitetura:** CeleryExecutor
- **PostgreSQL** como metadata database (`airflow` DB)
- **Redis** como message broker (Celery tasks)
- **MinIO** integrado via boto3/s3fs

**Pacotes pr√©-instalados:**
```
apache-airflow-providers-amazon
boto3
s3fs
```

**Credenciais:** `airflow/airflow`

**Diret√≥rios:**
```
./airflow/dags/      # DAG definitions
./airflow/logs/      # Execution logs
./airflow/plugins/   # Custom operators
./airflow/config/    # airflow.cfg
```

---

## üìä Estat√≠sticas Finais

- **Tempo total:** ~6 horas
- **Containers criados:** 11 (postgres, redis, minio, mlflow, opensearch, opensearch-dashboards, airflow x4, init x2)
- **Volumes criados:** 5 (postgres_data, redis_data, mlflow_data, minio_data, opensearch_data)
- **Arquivos criados:** 15+ (Dockerfiles, configs, docs)
- **Linhas de c√≥digo:** ~3000
- **Linhas de documenta√ß√£o:** ~3500 (incluindo INFRASTRUCTURE.md)
- **Problemas resolvidos:** 8

---

## üéØ Pr√≥ximos Passos

1. ‚úÖ **Infraestrutura completa** - CONCLU√çDO
2. **Semana 1-2:** Implementar DAGs Airflow para ingest√£o de dados
   - DAG 1: Ingest√£o di√°ria PNCP API ‚Üí lh-bronze
   - DAG 2: ETL lh-bronze ‚Üí lh-silver (limpeza, valida√ß√£o)
   - DAG 3: Feature engineering lh-silver ‚Üí lh-gold
3. **Bronze Layer:** Coletar 5k licita√ß√µes e salvar em `lh-bronze/licitacoes/`
4. **Editais PDF:** Baixar e salvar em `lh-bronze/editais_raw/`
5. **OpenSearch:** Indexar editais processados
6. **Silver Layer:** Processar e salvar em `lh-silver/licitacoes_clean/`
7. **Integra√ß√£o Python:** Criar m√≥dulos para leitura/escrita S3
8. **Great Expectations:** Configurar valida√ß√£o de qualidade de dados

---

## üìù Comandos √öteis

```bash
# Ver status dos containers
docker compose ps

# Ver logs em tempo real
docker compose logs -f

# Reiniciar um servi√ßo espec√≠fico
docker compose restart minio

# Parar tudo
docker compose down

# Parar e remover volumes (CUIDADO!)
docker compose down -v

# Ver uso de espa√ßo
docker system df -v

# Limpar recursos n√£o usados
docker system prune -a

# Ver portas expostas
docker compose ps --format "table {{.Service}}\t{{.Ports}}"

# Inspecionar rede
docker network inspect govcontracts-network

# Acessar MinIO CLI
mc alias set myminio http://localhost:9100 minioadmin minioadmin
mc ls myminio
```

---

# Airflow CLI
docker exec -it govcontracts-airflow-webserver airflow dags list
docker exec -it govcontracts-airflow-webserver airflow dags trigger <dag_id>
docker exec -it govcontracts-airflow-webserver airflow users list

# OpenSearch
curl http://localhost:9201/_cluster/health?pretty
curl http://localhost:9201/_cat/indices?v

# MinIO CLI (ainda √∫til)
mc alias set myminio http://localhost:9100 minioadmin minioadmin
mc ls myminio/lh-bronze
```

---

**Status:** ‚úÖ Data Platform completo e funcional (11 containers, 5 volumes)
**Pr√≥xima sess√£o:** Desenvolvimento de DAGs Airflow para ingest√£o de dados
